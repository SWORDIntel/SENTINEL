#!/usr/bin/env bash
# SENTINEL - AWS Security Module
# Version: 1.0.0
# Description: Provides helper functions and aliases for AWS security operations.
# Dependencies: logging

# --- Module Metadata ---
SENTINEL_MODULE_NAME="aws_security"
SENTINEL_MODULE_DESCRIPTION="AWS security helper functions and aliases"
SENTINEL_MODULE_VERSION="1.0.0"
SENTINEL_MODULE_DEPENDENCIES="logging"

# --- Configuration ---
# The default duration for assumed role sessions (in seconds).
AWS_ASSUME_ROLE_DURATION="${AWS_ASSUME_ROLE_DURATION:-3600}"

# --- Core Functions ---

# Assume an IAM role and export the temporary credentials.
# Usage: assume_role <role_arn> [role_session_name]
assume_role() {
    local role_arn="$1"
    local session_name="${2:-sentinel-session-$(date +%s)}"

    if [[ -z "$role_arn" ]]; then
        sentinel_log_error "aws_security" "Role ARN is required."
        return 1
    fi

    sentinel_log_info "aws_security" "Assuming role: $role_arn"

    local credentials
    credentials=$(aws sts assume-role \
        --role-arn "$role_arn" \
        --role-session-name "$session_name" \
        --duration-seconds "$AWS_ASSUME_ROLE_DURATION" \
        --query 'Credentials.[AccessKeyId,SecretAccessKey,SessionToken]' \
        --output text 2> >(sentinel_log_error "aws_security" >&2))

    if [[ -z "$credentials" ]]; then
        sentinel_log_error "aws_security" "Failed to assume role."
        return 1
    fi

    read -r key secret token <<< "$credentials"

    export AWS_ACCESS_KEY_ID="$key"
    export AWS_SECRET_ACCESS_KEY="$secret"
    export AWS_SESSION_TOKEN="$token"

    sentinel_log_info "aws_security" "Successfully assumed role. Credentials will expire in $(($AWS_ASSUME_ROLE_DURATION / 60)) minutes."
}

# --- Aliases ---

# Get the current caller identity
alias aws-whoami='aws sts get-caller-identity'

# List all IAM users
alias aws-list-users='aws iam list-users'

# List all IAM roles
alias aws-list-roles='aws iam list-roles'

# Get a summary of the account's access keys
alias aws-access-key-summary='aws iam get-account-summary | grep AccessKeys'

# --- Exports ---
export -f assume_role
