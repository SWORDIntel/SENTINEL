#!/usr/bin/env bash
# SENTINEL - Vault Integration Module
# Version: 1.0.0
# Description: Provides helper functions for interacting with HashiCorp Vault.
# Dependencies: logging

# --- Module Metadata ---
SENTINEL_MODULE_NAME="vault_integration"
SENTINEL_MODULE_DESCRIPTION="Vault integration helper functions"
SENTINEL_MODULE_VERSION="1.0.0"
SENTINEL_MODULE_DEPENDENCIES="logging"

# --- Core Functions ---

# Read a secret from Vault.
# Usage: vault_read <secret_path>
vault_read() {
    local secret_path="$1"

    if [[ -z "$secret_path" ]]; then
        sentinel_log_error "vault_integration" "Secret path is required."
        return 1
    fi

    if ! command -v vault &> /dev/null; then
        sentinel_log_error "vault_integration" "vault is not installed. Please install it to use this feature."
        return 1
    fi

    sentinel_log_info "vault_integration" "Reading secret from: $secret_path"

    vault read -field=value "$secret_path"
}

# Wrap a command and inject secrets as environment variables.
# Usage: vault_exec <secret_path> <command>
vault_exec() {
    local secret_path="$1"
    shift
    local cmd="$@"

    if [[ -z "$secret_path" ]]; then
        sentinel_log_error "vault_integration" "Secret path is required."
        return 1
    fi

    if [[ -z "$cmd" ]]; then
        sentinel_log_error "vault_integration" "Command is required."
        return 1
    fi

    if ! command -v vault &> /dev/null; then
        sentinel_log_error "vault_integration" "vault is not installed. Please install it to use this feature."
        return 1
    fi

    sentinel_log_info "vault_integration" "Executing command with secrets from: $secret_path"

    local secrets
    secrets=$(vault read -format=json "$secret_path" | jq -r '.data | to_entries | .[] | "export \(.key)=\(.value)"' > /tmp/secrets.txt)

    eval "$(< /tmp/secrets.txt)"

    eval "$cmd"
}

# --- Exports ---
export -f vault_read
export -f vault_exec
