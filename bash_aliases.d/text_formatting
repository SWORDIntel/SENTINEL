#!/usr/bin/env bash
# SENTINEL Text Formatting Aliases
# Enhanced text formatting and manipulation utilities for command line operations
# Based on original work by Jason Thistlethwaite (2013)
# Enhanced for SENTINEL (2023)

# CSV Processing
# -------------
# Format CSV data for human-readable display (removes quotes and replaces commas with spaces)
function dcsv() {
    if [ -p /dev/stdin ]; then
        sed -e 's/,/ /g' -e 's/"//g'
    else
        echo "Error: No input provided. Use this function with a pipe." >&2
        return 1
    fi
}

# Format CSV with proper column alignment
function csvview() {
    if [ -p /dev/stdin ]; then
        if command -v pv >/dev/null 2>&1; then
            pv -q | column -s, -t
        else
            column -s, -t
        fi
    else
        echo "Error: No input provided. Use this function with a pipe." >&2
        return 1
    fi
}

# Format CSV with headers preserved and colored
function csvsmart() {
    if [ -p /dev/stdin ]; then
        awk -F, 'NR==1 {print "\033[1;32m" $0 "\033[0m"; next} {print}' | column -s, -t
    else
        echo "Error: No input provided. Use this function with a pipe." >&2
        return 1
    fi
}

# Format CSV with alternating row colors for readability
function csvcolor() {
    if [ -p /dev/stdin ]; then
        awk -F, '{if(NR%2==0) printf "\033[48;5;236m"; printf $0 "\033[0m\n"}' | column -t -s,
    else
        echo "Error: No input provided. Use this function with a pipe." >&2
        return 1
    fi
}

# Text Transformations
# -------------------
# Convert text to uppercase
alias upper='tr "[:lower:]" "[:upper:]"'

# Convert text to lowercase
alias lower='tr "[:upper:]" "[:lower:]"'

# Convert first character of each word to uppercase (title case)
alias titlecase='sed "s/\b\(.\)/\u\1/g"'

# Format JSON nicely with colors (requires python)
alias jsonpp='python -m json.tool | pygmentize -l json 2>/dev/null || python -m json.tool'
alias jsonfmt='python -m json.tool'

# Format XML nicely with colors (requires xmllint and pygmentize)
alias xmlpp='xmllint --format - | pygmentize -l xml 2>/dev/null || xmllint --format -'

# Text Filtering
# -------------
# Strip all ANSI color codes from text
alias nocolor='sed -r "s/\x1B\[([0-9]{1,3}(;[0-9]{1,3})*)?[mGK]//g"'

# Remove empty lines
alias noempty='grep -v "^[[:space:]]*$"'

# Remove duplicate lines while maintaining original order
function uniqo() {
    if [ -p /dev/stdin ]; then
        awk '!seen[$0]++'
    else
        echo "Error: No input provided. Use this function with a pipe." >&2
        return 1
    fi
}

# Remove lines with comments (# style)
alias nocomments='grep -v "^[[:space:]]*#"'

# Remove leading and trailing whitespace
alias trim='sed -e "s/^[[:space:]]*//" -e "s/[[:space:]]*$//"'

# Text Statistics
# --------------
# Count words, lines, and characters
alias wc-stats='wc -lwm'

# Advanced word frequency counter
alias wordfreq='tr -s "[:space:]" "\n" | tr "[:upper:]" "[:lower:]" | sort | uniq -c | sort -nr | head -20'

# Count unique lines
alias countuniq='sort | uniq -c | sort -nr'

# Data Extraction
# --------------
# Extract IP addresses from text
alias extractip='grep -oE "\b([0-9]{1,3}\.){3}[0-9]{1,3}\b"'

# Extract email addresses from text
alias extractemail='grep -oE "\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,6}\b"'

# Extract URLs from text
alias extracturl='grep -oE "(https?|ftp|file)://[-A-Za-z0-9+&@#/%?=~_|!:,.;]*[-A-Za-z0-9+&@#/%=~_|]"'

# Extract MD5 hashes
alias extractmd5='grep -oE "\b[a-fA-F0-9]{32}\b"'

# Extract SHA1 hashes
alias extractsha1='grep -oE "\b[a-fA-F0-9]{40}\b"'

# Extract SHA256 hashes
alias extractsha256='grep -oE "\b[a-fA-F0-9]{64}\b"'

# Code Formatters
# --------------
# Format shell scripts and use syntax highlighting if available
alias bashfmt='shfmt -i 2 -bn -ci -sr -kp | pygmentize -l bash 2>/dev/null || shfmt -i 2 -bn -ci -sr -kp'

# Table Display Functions
# ---------------------
# Show data as ASCII table with custom headers
# Usage: table_display "header1,header2,header3" "data1,data2,data3" "data4,data5,data6"
function table_display() {
    local headers="$1"
    local temp_file="/tmp/table_data_$$.csv"
    local log_file="/tmp/table_display_$$.log"

    # Input validation
    if [ -z "$headers" ]; then
        echo "Error: Headers are required" >&2
        return 1
    fi

    # Logging setup
    exec 3>&2 2>"$log_file"

    # Create temporary file with proper cleanup
    trap 'rm -f "$temp_file" "$log_file"' EXIT

    echo "$headers" > "$temp_file"
    shift

    # Process data rows
    local row_count=0
    for line in "$@"; do
        echo "$line" >> "$temp_file"
        ((row_count++))
        echo "Processing row $row_count" >&2
    done

    # Check if we have any data
    if [ "$row_count" -eq 0 ]; then
        echo "Warning: No data rows provided" >&2
    fi

    # Display the table with progress indicator if available
    if command -v pv >/dev/null 2>&1 && [ "$row_count" -gt 1000 ]; then
        pv -q "$temp_file" | column -t -s,
    else
        column -t -s, < "$temp_file"
    fi

    # Restore stderr and cleanup
    exec 2>&3
}

# Advanced Diff with Color
# ----------------------
# Show differences between two files with line numbers and colors
alias diffpretty='diff --color=always --side-by-side --line-numbers'

# Grep with Context and Colors
# --------------------------
# Search with pretty output
alias grepc='grep --color=always -n -A 2 -B 2'

# Text Encoding/Decoding
# --------------------
# URL encode a string
alias urlencode='python -c "import sys, urllib.parse; print(urllib.parse.quote(sys.stdin.read().strip()))"'

# URL decode a string
alias urldecode='python -c "import sys, urllib.parse; print(urllib.parse.unquote(sys.stdin.read().strip()))"'

# Base64 encode a string
alias b64encode='base64'

# Base64 decode a string
alias b64decode='base64 -d'

# Hex encode a string
alias hexencode='xxd -p'

# Hex decode a string
alias hexdecode='xxd -p -r'

# Check for recommended commands for enhanced functionality
for cmd in pv tqdm; do
    if ! command -v $cmd >/dev/null 2>&1; then
        echo "Note: $cmd is not installed. Some progress indicators will not be available."
        case $cmd in
            pv)
                echo "  Install with: sudo apt install pv  # Debian/Ubuntu"
                echo "  Install with: sudo yum install pv  # RHEL/CentOS"
                ;;
            tqdm)
                echo "  Install with: pip install tqdm"
                ;;
        esac
    fi
done
